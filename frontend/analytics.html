<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - ZETA</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .analytics-dashboard {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-8);
        }

        .analytics-header {
            margin-bottom: var(--space-10);
        }

        .analytics-header h1 {
            font-size: 2.5rem;
            color: var(--primary-600);
            margin-bottom: var(--space-4);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--primary-600);
            text-decoration: none;
            font-weight: 600;
            transition: all var(--transition-base);
        }

        .back-link:hover {
            transform: translateX(-4px);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-6);
            margin-bottom: var(--space-10);
        }

        .stat-card {
            background: var(--bg-primary);
            padding: var(--space-6);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-500);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            line-height: 1;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            font-weight: 500;
        }

        .progress-section {
            background: var(--bg-primary);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-8);
            border: 1px solid var(--border-primary);
        }

        .progress-section h3 {
            font-size: 1.5rem;
            color: var(--primary-600);
            margin-bottom: var(--space-6);
            font-weight: 700;
        }

        .topic-progress-item {
            margin-bottom: var(--space-5);
            padding: var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
        }

        .topic-progress-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-sm);
        }

        .topic-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .topic-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.0625rem;
        }

        .topic-stats {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .progress-bar-container {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-600), var(--primary-500));
            border-radius: var(--radius-full);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .chart-container {
            background: var(--bg-primary);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-8);
            border: 1px solid var(--border-primary);
        }

        .chart-container h3 {
            font-size: 1.5rem;
            color: var(--primary-600);
            margin-bottom: var(--space-6);
            font-weight: 700;
        }

        .activity-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(32px, 1fr));
            gap: 4px;
            max-width: 100%;
        }

        .heatmap-day {
            aspect-ratio: 1;
            border-radius: 4px;
            background: var(--bg-secondary);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .heatmap-day:hover {
            transform: scale(1.2);
            z-index: 10;
            box-shadow: var(--shadow-md);
        }

        .heatmap-day[data-level="0"] { background: var(--gray-100); }
        .heatmap-day[data-level="1"] { background: var(--primary-200); }
        .heatmap-day[data-level="2"] { background: var(--primary-400); }
        .heatmap-day[data-level="3"] { background: var(--primary-600); }
        .heatmap-day[data-level="4"] { background: var(--primary-800); }

        .dark-theme .heatmap-day[data-level="0"] { background: var(--gray-800); }

        .achievement-section {
            background: var(--bg-primary);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
            margin-bottom: var(--space-8);
        }

        .achievement-section h3 {
            font-size: 1.5rem;
            color: var(--primary-600);
            margin-bottom: var(--space-6);
            font-weight: 700;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--space-4);
        }

        .achievement-badge {
            text-align: center;
            padding: var(--space-5);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .achievement-badge.unlocked {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .dark-theme .achievement-badge.unlocked {
            background: rgba(168, 85, 247, 0.1);
        }

        .achievement-badge.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        .achievement-badge:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .achievement-icon {
            font-size: 3rem;
            margin-bottom: var(--space-2);
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .achievement-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            line-height: var(--leading-relaxed);
        }

        .leaderboard-section {
            background: var(--bg-primary);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-primary);
        }

        .leaderboard-section h3 {
            font-size: 1.5rem;
            color: var(--primary-600);
            margin-bottom: var(--space-6);
            font-weight: 700;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-sm);
        }

        .leaderboard-rank {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border-radius: var(--radius-full);
            background: var(--primary-100);
            color: var(--primary-600);
            font-size: 1.125rem;
            flex-shrink: 0;
        }

        .leaderboard-rank.top-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            font-size: 1.25rem;
        }

        .leaderboard-rank.top-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #000;
        }

        .leaderboard-rank.top-3 {
            background: linear-gradient(135deg, #cd7f32, #e6a857);
            color: #000;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }

        .leaderboard-stats {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .leaderboard-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-600);
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-16);
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
        }
    </style>
</head>
<body class="light-theme">
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="back-link">‚Üê Back to Home</a>
            </div>
            <div class="header-right">
                <button id="themeToggle" class="header-btn theme-btn">
                    <span class="theme-icon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <div class="analytics-dashboard">
        <div class="analytics-header">
            <h1>üìä Your Analytics</h1>
        </div>
        
        <!-- Key Stats -->
        <div class="analytics-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-value" id="accuracyStat">--%</div>
                <div class="stat-label">Overall Accuracy</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üìù</div>
                <div class="stat-value" id="questionsStat">--</div>
                <div class="stat-label">Questions Answered</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-value" id="streakStat">--</div>
                <div class="stat-label">Day Streak</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-value" id="timeStat">--</div>
                <div class="stat-label">Time Spent</div>
            </div>
        </div>

        <!-- Topic Progress -->
        <div class="progress-section">
            <h3>üìö Topic Progress</h3>
            <div id="topicProgressList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>Loading your progress...</p>
                </div>
            </div>
        </div>

        <!-- Activity Heatmap -->
        <div class="chart-container">
            <h3>üìÖ Activity Heatmap - Last 30 Days</h3>
            <div class="activity-heatmap" id="activityHeatmap">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Achievements -->
        <div class="achievement-section">
            <h3>üèÜ Achievements</h3>
            <div class="achievements-grid" id="achievementsList">
                <!-- Dynamically populated -->
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard-section">
            <h3>üëë Top Learners</h3>
            <div id="leaderboardList">
                <div class="empty-state">
                    <div class="empty-state-icon">üèÜ</div>
                    <p>Loading leaderboard...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/state-manager.js"></script>
    <script src="js/api-client.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeStore();
            loadTheme();
            setupThemeToggle();
            checkAuth();
            loadAnalytics();
        });

        function checkAuth() {
            const token = store.getState('token');
            if (!token) {
                window.location.href = 'login.html';
            }
        }

        function loadTheme() {
            const theme = store.getState('theme') || 'light';
            document.body.className = `${theme}-theme`;
            updateThemeIcon(theme);
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        }

        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    document.body.className = `${newTheme}-theme`;
                    store.setState({ theme: newTheme });
                    updateThemeIcon(newTheme);
                });
            }
        }

        async function loadAnalytics() {
            try {
                // Load user analytics
                try {
                    const data = await api.get('/analytics/user');
                    // ... rest of code
                } catch (error) {
                    console.error('Failed to load analytics:', error);
                    if (error.status === 401) {
                        localStorage.clear();
                        window.location.href = 'login.html';
                    } else {
                        showError(error.message || 'Failed to load analytics data');
                    }
                }
                
                // Update stats
                document.getElementById('accuracyStat').textContent = `${data.accuracy}%`;
                document.getElementById('questionsStat').textContent = data.totalQuestions;
                document.getElementById('streakStat').textContent = data.streak;
                const hours = Math.floor(data.timeSpent / 3600);
                const minutes = Math.floor((data.timeSpent % 3600) / 60);
                document.getElementById('timeStat').textContent = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

                // Load topic progress
                loadTopicProgress(data.topicProgress);

                // Load activity heatmap
                loadActivityHeatmap(data.activityData);

                // Load achievements
                loadAchievements(data.achievements);

                // Load leaderboard
                await loadLeaderboard();
            } catch (error) {
                console.error('Failed to load analytics:', error);
                showError('Failed to load analytics data');
            }
        }

        function loadTopicProgress(topics) {
            const container = document.getElementById('topicProgressList');
            
            if (!topics || topics.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <p>Start answering questions to see your progress!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = topics.map(topic => `
                <div class="topic-progress-item">
                    <div class="topic-progress-header">
                        <span class="topic-name">${topic.name}</span>
                        <span class="topic-stats">${topic.answered}/${topic.total} ‚Ä¢ ${topic.accuracy}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${(topic.answered/topic.total)*100}%"></div>
                    </div>
                </div>
            `).join('');
        }

        function loadActivityHeatmap(activityData) {
            const container = document.getElementById('activityHeatmap');
            if (!activityData || activityData.length === 0) {
                container.innerHTML = '<p class="empty-state">No activity data available</p>';
                return;
            }

            const maxActivity = Math.max(...activityData, 1);

            container.innerHTML = activityData.map((activity, i) => {
                const level = activity === 0 ? 0 : Math.min(Math.ceil((activity / maxActivity) * 4), 4);
                const date = new Date();
                date.setDate(date.getDate() - (29 - i));
                return `<div class="heatmap-day" 
                             data-level="${level}" 
                             title="${activity} questions on ${date.toLocaleDateString()}"></div>`;
            }).join('');
        }

        function loadAchievements(achievements) {
            const container = document.getElementById('achievementsList');
            
            if (!achievements || achievements.length === 0) {
                container.innerHTML = '<p class="empty-state">No achievements yet</p>';
                return;
            }

            container.innerHTML = achievements.map(ach => `
                <div class="achievement-badge ${ach.unlocked ? 'unlocked' : 'locked'}">
                    <div class="achievement-icon">${ach.icon}</div>
                    <div class="achievement-name">${ach.name}</div>
                    <div class="achievement-desc">${ach.description}</div>
                </div>
            `).join('');
        }

        async function loadLeaderboard() {
            try {
                const data = await api.get('/analytics/leaderboard?limit=10');
                const container = document.getElementById('leaderboardList');
                
                if (!data.leaderboard || data.leaderboard.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üèÜ</div>
                            <p>No leaderboard data available yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.leaderboard.map((user, index) => `
                    <div class="leaderboard-item">
                    <div class="leaderboard-rank ${index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : ''}">${index + 1}</div>
                    <div class="leaderboard-info">
                    <div class="leaderboard-name">${user.fullname}</div>
                    <div class="leaderboard-stats">${user.totalAnswered} questions ‚Ä¢ ${user.accuracy}% accuracy ‚Ä¢ ${user.streak} day streak</div>
                    </div>
                    <div class="leaderboard-score">${user.score}</div>
                    </div>
                    `).join('');
                    } catch (error) {
                    console.error('Failed to load leaderboard:', error);
                    }
                    }
                    function showError(message) {
                    alert(message); // Simple error handling, replace with toast
    }
</script>
</body>
</html>